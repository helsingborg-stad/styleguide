/**
 * Design Tokens Compiler
 *
 * Reads source/data/design-tokens.json and generates
 * source/sass/setting/_design-tokens.scss
 *
 * Usage:
 *   node build-design-tokens.mjs
 */

import { readFileSync, writeFileSync } from 'fs';
import { resolve, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));

const INPUT  = resolve(__dirname, 'source/data/design-tokens.json');
const OUTPUT = resolve(__dirname, 'source/sass/setting/_design-tokens.scss');

function buildScss(data) {
    const lines = [];

    lines.push('// ============================================================================');
    lines.push('// DESIGN TOKENS');
    lines.push('// ============================================================================');
    lines.push('//');
    lines.push(`// AUTO-GENERATED from source/data/design-tokens.json (v${data.version || '0.0.0'})`);
    lines.push('// DO NOT EDIT THIS FILE MANUALLY — changes will be overwritten.');
    lines.push('//');
    lines.push('// To modify design tokens, edit source/data/design-tokens.json and run:');
    lines.push('//   node build-design-tokens.mjs');
    lines.push('//');
    lines.push('// ============================================================================');
    lines.push('');
    lines.push(':root {');

    for (const category of data.categories) {
        lines.push('');
        lines.push('    // ' + '='.repeat(72));
        lines.push(`    // ${category.label}`);

        if (category.description) {
            lines.push(`    // ${category.description}`);
        }

        lines.push('    // ' + '='.repeat(72));

        for (const setting of category.settings) {
            const name  = setting.variable;
            const value = formatValue(setting);

            lines.push(`    ${name}: ${value};`);
        }
    }

    lines.push('}');
    lines.push('');

    return lines.join('\n');
}

function formatValue(setting) {
    const val = setting.default;

    // Strings that are already CSS expressions (var(), calc(), etc.) pass through
    if (typeof val !== 'string') {
        return String(val);
    }

    // Font families and other quoted values — keep as-is
    if (val.startsWith('var(') || val.startsWith('calc(')) {
        return val;
    }

    return val;
}

// Main
const json = readFileSync(INPUT, 'utf-8');
const data = JSON.parse(json);
const scss = buildScss(data);

writeFileSync(OUTPUT, scss, 'utf-8');

const tokenCount = data.categories.reduce((sum, c) => sum + c.settings.length, 0);
console.log(`Generated ${OUTPUT}`);
console.log(`  ${data.categories.length} categories, ${tokenCount} tokens`);
